---
title: "Single Linear Regression I"
author: "Manu Navjeevan"
date: "08/16/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Lecture's Objective

The main object for today is to start implementing single linear regression in R.
The discussion follows closely "*Principles of Econometrics with R*" by Constantin Colonescu (available for free at https://bookdown.org/ccolonescu/RPoE4/).

## Getting the DataSets

In order to map our discussion as closely as possible to the concepts discussed in 103, we will employ many of the same datasets.
The datasets are available online and conveniently uploaded into a library that we can call from R.
To make sure we have access to them we need to run:

```{r start1}
# In order to download the data we will need the "devtools" package.
# Remember that to install a package from CRAN we can use the install.packages("name") command.

# Warning: You only need to run the code below once and it may not run properly if you use "knit". If you are having problems, try copying and pasting the line into the console.
#install.packages("devtools")

# Once installed we need tell R that we want to use it
# Warning: For this line to work, you must have "devtools" installed.
library("devtools")

# Finally, we can use the install_git function in the devtools package to download the data
# Warning: You only need to run the code below once and it may not run properly if you use "knit". If you are having problems, try copying and pasting the line into the console.
#install_git("https://github.com/ccolonescu/PoEdata")

# This has downloaded the book datasets for us. But remember we still need to tell R we want to use them
# Warning: For this line to work, you must have run the previous "install_git" line (just once)
library(PoEdata)

```

For future uses we do not have to redo all these steps.
The files should now be in our computer, so the important step for future sessions is just typing the `library(PoEdata)` command so that R is aware that we want to use those files.
Also note that we used the `install_git` function without much explanation. 
We will not use it often, but if you are curious about how it works remember that you can always ask R for help: just use the `?` command -- i.e. type `?install_git` into the R console.

Now that we have access to the datasets we can load them and start working with them.
A useful tool for doing so is the `data` command (again remember, you can always type `?data` to learn how the function works).
Let's see if we can figure out how to use `data` from its description.

```{r start2}

# Ask R for help on the data function
#?data

# Can you see from the description how to learn what available datasets are?
data()

# The datasets listed under the PoEData library are the ones from the book. 
# The `food` file contains the data on food expenditures. 
# Can you figure out how to load the data sets by using ?data ?
data(food)

```

Notice that after loading the *food* datasets a variable called food has appeared in the upper right corner of the screen.
The name is *food* and the description tells is there are 40 obs with 2 variables. 
The variable *food* is an *object* (remember previous lecture?). 
We can access the data stored in an object by simply typing its name on the console.

```{r start3}

# Type the variable food to see what is in it
food

```

We should see three columns.
The first is simply enumerating the observations, while the second and third columns are food_exp and income (notice their names on the first row). 
Simply typing in the name of the object *food* works to learn about what is stored in it because this is a small dataset.
However, this is clearly impractical when working with much larger datasets (think hundred of thousands of observations).
To see just a couple of rows (instead of the whole list), remember we can use brackets to reference a subset of the data.

```{r start4}

# Display only all the first five rows of the food dataset
food[1:5,]

```

The `[,]` commands are very helpful. Try different examples to make sure you understand how it works. 
For example, tell R to: (i) Display the first 10 rows and all columns, (ii) Display the first 2 rows and column 1, (iii) Display rows 3 through 10 in column 2.

## Linear Regression

Now that we have the dataset *food* loaded into our workspace we can try to run a linear regression.
The function for running linear regressions is called `lm`.
As always, we can use the `?` command to ask R for help on how `lm` works by typing `?lm`. 

```{r start5}

# Ask R how the function `lm` works
?lm
```
From the description, we should see that the first two arguments we feed `lm` are the key ones (rest are optional)

* The first argument tells `lm` the formula of the regression we want to run -- i.e., who is on the left hand side and who is on the right hand side. For example, if we wanted to regress a variable `y` on a variable `x` we would write `y ~ x`. Note that the constant is automatically included!
* The second argument tells `lm` where the data is for the regression we are specifying -- here you just need to type in the name of the relevant dataset.

Let's begin by running a regression of *food_exp* on *income*.

```{r start6}

# Run a regression of food_exp on income
lm(food_exp ~ income, food)

```

Running the code directly on the console (or using the green arrow button on the code window) will display the answer: The intercept on the regression is 83.42 and the coefficient on income is 10.21.
It is helpful to have access to the coefficients (and other output). 
To do this, we can just assign the output of the `lm` function to an object using the command `<-` as always.

```{r start7}

# Run a regression of food_exp on income and save output into an object called regout
regout <- lm(food_exp ~ income, food)

# Type the name regout to see what has been stored into this object
regout
```

Note that typing the name of the object `regout` into the console tells us the coefficients.
However, if you read the description from `?lm` carefully, you'll see that the function `lm` actually creates a lot more output than just the coefficients. Where is all this information?
It has been stored in the variable `regout` but we need to work a bit harder to access it. 
You can tell something is missing, because if you look at the upper right corner in RStudio you'll see that the object `regout` is described as a list of 12 ... that's a lot more than the 2 coefficients!
A useful command for seeing everything stored in an object is `attributes`. 
Note the function `attributes` can be applied to any type of object and as usual we can ask R for help by typing `?attributes`.
Let's try seeing the attributes of `regout` to see what exactly is in it.


```{r start8}

# Use the function attributes to learn what is in regout
attributes(regout)
```

The printout in the console tells us all the different fields that we can access in the object `regout`.
The description of each field can be found in the decription of `lm` (again by typing `?lm`).
To access any of these fields remember that we can use the `$` sign.
Let's try some examples:

```{r start9}

# Print out the coefficients in regout
regout$coefficients

# Print out the intercept in the regression
regout$coefficients[1]

# Print out the first 10 residuals from the regression
regout$residuals[1:10]

# Print out all the predicted values from the regression
regout$fitted.values

```

As we can see, the object *regout* has all the information we need to compute all sorts of statistics (such as r-squared or conduct inference). 
We can always do that ourselves, by accessing the data in *regout* and doing the calculations we want.
Let's do an example: Compute the estimate of the variance of the residuals using the formula from 103 as (sum residual^2)/n.


```{r start10}
# Compute our estimate of the variance of the residuals
# First helpful to find n, where n is the number of observations
# This can be found by taking the number of rows in our dataframe 
# This in turn can be found using the function nrow
n <- nrow(food)

# Our estimate is the sum of the squares divided by n
sum((regout$residuals^2)/n)

# Compute the standard deviation of the residuals
(sum((regout$residuals^2)/n))^(0.5)

```

There is also a convenient function called `summary` that computes many of the standard statistics for regression analysis that we have seen (and many that we are still to see) in class.

```{r start11}
# Apply the summary function to regout
summary(regout)

# As always we can save the output into an object using the <- command.
# Save the output into an object called regsum
regsum <- summary(regout)

```

Just like for the object `regout`, the object `regsum` has more features that meet the eye.
We can learn what the information contained in `regum` is by using the `attributes` function (just like we did for `regout`).
As a final example, search for the name of the covariance matrix of the coefficients and print out what the estimated covariance between the intercept and the coefficient on income is.

```{r start12}
# Apply the attributes function to regsum
attributes(regsum)

# Print out the r squared value of the regression
regsum$r.squared
```


## Some Extensions

One of the appeals of R is that it is an extremely powerful tool for making graphs.
Graphs are also often a very helpful way for gaining insights into the data, so let's spend a bit of time on the basics of plotting.
The most basic function for graphs is the `plot` function.
One of its most basic uses is to graph a scatter plot.
For example, if we want to do a scatterplot of vectors `x` and `y` we would just type `plot(x,y)`. 
Let's try it out with the *food* dataset

``` {r start13}

# Draw a scatter plot with income in the x axis and food expenditure on the y axis
plot(food$income, food$food_exp)

```

Notice the resulting plot named the axis using the names of the corresponding variables. 
To change the name of the axes to whatever we want we can use the `xlab` and `ylab` commands when using the plot function. 
As an example we can re-draw the scatter plot of the *food* data but adding our own labels.

``` {r start14}

# Draw a scatter plot with income in the x axis and food expenditure on the y axis
plot(food$income, food$food_exp, xlab = "Income", ylab = "Food Expenditures")

```

To get a feel of what are regression coefficients mean, it is also helpful to graph the fitted line together with the scatter plot of the raw data.
A useful function for graphing functions is the `curve` function. 
To use this function, all we need to do is tell it what function we want to graph -- e.g., the command `curve(1 + 2*x)` will graph the function y = 1 + 2*x. Let's graph the fitted regression line on the scatter plot:

``` {r start15}

# Draw a scatter plot with income in the x axis and food expenditure on the y axis
plot(food$income, food$food_exp, xlab = "Income", ylab = "Food Expenditures")

# Now add the fitted line from our regression
curve(regout$coefficients[1] + regout$coefficients[2]*x, add = TRUE)

```

Notice that when we called the curve function we added the command `add = TRUE`. 
This lets `curve` know that we want to add the line to the graph that is open (which is the scatter plot).
If we excluded the command `add = TRUE`, then the `curve` function would create a *new* graph with the fitted line but without the scatter plot (you should give it a try!).
Also note that when defining the function that we wanted `curve` to graph we referenced the regression coefficients by using the fact that they were stored in the `regout` variable as `regout$coefficients` with `regout$coefficients[1]` being the intercept and `regout$coefficients[2]` being the coefficient for income.

To conclude let's just do a final exercise where we regress *food expenditure* on *income squared* and graph both the raw data and the fitted regression line. 
By now we have created a lot of variables, so we will clear our workspace before getting started.


``` {r start16}

# Clear the workspace
rm(list = ls())

# Since we cleared everything we need to tell R again that we want to use the PoE datasets
library(PoEdata)

# And reload the food data
data(food)

```

Now that we have the data we can run the regression of *food expenditure* on *income squared*.
One last trick to know is that when asking R to use a transformation of a variable in the regression we need to include the transformation inside the function `I()`. The code below illustrates.

```{r state17}

# Next let's regress food expenditure on income squared. Note the use of I() function
regout <- lm(food_exp ~ I(income^2), food)

# Let's do a scatter plot
plot(food$income, food$food_exp, xlab = "Income", ylab = "Food Expenditures")


# Now add the fitted line from our regression
curve(regout$coefficients[1] + regout$coefficients[2]*x^2, add = TRUE)

```

This concludes covering the very basics of liner regression in R.
To practice, you should try to load a dataset from the PoEdata library and run your own non linear regressions.
